# 設計仕様書: PDF構造分解サービス

## 1. 目的

本仕様書は `PRD.md` の要求を、実装方式に依存しない設計契約として定義する。
対象は PDF 構造分解サービスであり、具体ユースケース実装は対象外とする。

## 2. スコープ

### 2.1 対象
- 目次付き書籍 PDF の論理構造抽出
- 階層正規化とページ範囲決定
- テキスト抽出（必要時 OCR 利用）
- トークン上限を満たすチャンク化
- チャンクへの追跡可能なメタデータ付与

### 2.2 非対象
- UI 提供
- PDF 編集機能
- レイアウト完全再現
- TTS/要約/検索アプリ本体の提供

## 3. サービス特性

### 3.1 入出力契約
- 入力は PDF と処理設定を受け取る
- 出力は階層情報付きチャンク集合を返す
- 失敗時は分類済みエラーを返す

### 3.2 品質特性
- 構造整合性: TOC と本文の不整合を検出可能
- 型安全性: 境界で検証し内部は不変モデルを維持
- 拡張性: 階層深度と外部連携方式の変更に耐える
- 可観測性: 処理段階と失敗理由を追跡できる

## 4. ドメインモデル契約

### 4.1 TOC ノード
- 階層レベル
- 見出しテキスト
- 開始/終了ページ
- 子ノード集合

### 4.2 チャンク
- 文書識別子
- 階層パス
- ページ範囲
- 本文テキスト
- トークン数

### 4.3 制約
- ページ範囲は単調増加かつ整合していること
- 不正状態はモデル生成時点で拒否すること

## 5. 処理契約

### 5.1 標準フロー
1. 入力検証
2. TOC 抽出
3. 階層正規化
4. テキスト抽出
5. チャンク分割
6. メタデータ付与
7. 出力生成

### 5.2 振る舞い要件
- チャンクは設定されたトークン上限を超えない
- 抽出不能ページは分類エラーとして報告する
- 分割不能時は処理失敗を明示的に返す

## 6. エラー契約

### 6.1 分類
- 入力検証エラー
- TOC 抽出/整合性エラー
- OCR エラー
- 外部連携エラー
- トークン制約エラー

### 6.2 取り扱い
- 包括例外で握りつぶさない
- エラーはコードと文脈情報を持つ
- 再試行可能な失敗のみ再試行対象とする

## 7. 運用契約

### 7.1 ログ
- 最低限 `doc_id`, `stage`, `result`, `error_code`, `elapsed_ms` を記録
- 監査可能な粒度で処理境界を記録

### 7.2 設定
- トークン上限
- OCR 有効/無効とタイムアウト
- 外部連携タイムアウト/再試行
- ログレベル

## 8. 検証契約

### 8.1 単体検証
- 階層正規化
- ページ範囲算定
- 分割ロジック
- エラー分類

### 8.2 結合検証
- テキスト PDF / 画像 PDF の両系統
- OCR 分岐の成立
- 大規模入力での完走性

## 9. 完了条件

- `PRD.md` と矛盾しない
- スコープ外機能を含まない
- モデル/処理/エラー/検証の契約が文書化されている
