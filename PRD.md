# PRD: PDF構造分解・処理パイプライン

## 1. 目的

PDF文書を目次（TOC）を基準として階層構造に分解し、
ユーザが処理可能な情報単位へ変換する。

分解後のデータは以下用途に利用する：

- 音声化（TTS）
- 要約生成
- 外部LLM処理
- ベクトル検索
- 学習補助

## 2. 背景

PDFは以下の問題を持つ：

- 論理構造と物理構造が一致しない
- 書籍ごとに階層が異なる
- テキストPDFと画像PDFが混在
- 章単位では大きすぎることがある

本システムは、**目次を基準に論理構造を抽出し、用途別に最適粒度へ再分割すること**を目的とする。

## 3. スコープ

### 対象

- 書籍形式PDF
- 目次付きPDF
- 日本語を主とする文書

### 非対象

- レイアウト完全再現
- PDF編集機能
- UI提供（CLI/API前提）

## 4. ユースケース

> **補足**: このPRDではユースケースの実装を扱わず、以下に示すのは期待される活用例の参照情報です。実際の挙動や機能の実装対象は本ドキュメントの機能要件・非機能要件およびスコープで定義した範囲に限定されます。

### UC-1: 音声化

- 章または節単位でTTS
- 最大音声時間制限あり

### UC-2: 要約生成

- トークン上限内に分割
- 再帰要約を実行

### UC-3: ベクトル検索

- 意味単位でチャンク分割
- メタ情報付き保存

## 5. 機能要件

### FR-1: 目次抽出

- PDFアウトライン取得
- 目次ページ解析（代替手段）
- 階層レベル推定
- 開始ページ特定

### FR-2: 階層正規化

- 可変深度対応
- N階層木構造生成
- ページ範囲自動確定

### FR-3: テキスト抽出

- テキストレイヤ優先
- 空文字の場合はOCR実行
- ページ単位判定

### FR-4: チャンク分割

- トークン上限制御
- 章・節単位を優先
- 超過時は再分割

### FR-5: メタデータ付与

- doc_id
- 階層パス
- ページ範囲
- トークン数

### FR-6: 外部サービス連携

- 要約API
- TTS API
- エラー処理と再試行

## 6. 非機能要件

### NFR-1: 構造整合性

- 目次と本文の不整合を検出可能

### NFR-2: 型安全

- 境界で検証
- 内部モデルは不変

### NFR-3: 可観測性

- 構造化ログ出力
- 失敗の分類

### NFR-4: 拡張性

- 階層深度に依存しない設計
- 外部サービス差し替え可能

### NFR-5: 処理性能

- 300ページ規模PDFに対応
- メモリ爆発回避

## 7. データモデル要件

### TocNode

- level
- title
- page_start
- page_end
- children

### Chunk

- doc_id
- node_path
- page_start
- page_end
- text
- tokens

## 8. エラー分類

- TOC抽出失敗
- ページ範囲不整合
- OCR失敗
- 外部API失敗
- トークン超過

## 9. 成功基準

- 目次階層を正しく再現できる
- チャンクがトークン上限を超えない
- OCR分岐が自動判定される
- 要約パイプラインが完走する

## 10. 今後の拡張

- レイアウト推定による構造補完
- 並列処理
- キャッシュ機構
- 永続ストレージ統合

## 11. 未確定事項

- 最大想定PDFサイズ
- 処理をバッチにするかリアルタイムにするか
- 多言語対応範囲
- 外部API依存度

---

このPRDは実装前提の骨子である。
さらに精緻化するなら、次段階は：

- シーケンス図
- エラー状態遷移図
- 型設計仕様書
- スケーラビリティ設計

どの方向に深掘るか明確にする必要がある。
